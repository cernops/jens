#!/usr/bin/python3
# SPDX-FileCopyrightText: 2016-2023 CERN
# SPDX-License-Identifier: GPL-3.0-or-later

import sys
import logging
import argparse

from jens.errors import JensConfigError
from jens.errors import JensMessagingError
from jens.settings import Settings
from jens.messaging import purge_queue

def parse_cmdline_args():
    """Parses command line parameters."""
    parser = argparse.ArgumentParser()
    parser.add_argument('-c', '--config',
                      help="Configuration file path "
                           "(defaults to '/etc/jens/main.conf'",
                      default="/etc/jens/main.conf")
    return parser.parse_args()

def main():
    """Application entrypoint."""
    opts = parse_cmdline_args()

    settings = Settings("jens-purge-queue")
    try:
        settings.parse_config(opts.config)
    except JensConfigError as error:
        logging.error(error)
        return 2

    try:
        logging.info("Purging %s...", settings.MESSAGING_QUEUEDIR)
        purge_queue()
    except JensMessagingError as error:
        logging.error(error)
        return 10

    logging.info("Done")
    return 0

if __name__ == '__main__':
    sys.exit(main())
